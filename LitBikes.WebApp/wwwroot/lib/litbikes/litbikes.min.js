var Util,Model,Game;!function(t){var e=function(){function t(t,e){this.x=t,this.y=e}return t.distance=function(t,e){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)},t}();t.Vector=e;var i=function(){function t(){}return t.randInt=function(t,e){return Math.floor(Math.random()*(e-t+1))+t},t.rand255=function(){return Math.floor(256*Math.random())},t.sameVector=function(t,e,i){void 0===i&&(i=0);var n=t.x-e.x,s=t.y-e.y;return n>=i&&n<=i&&s>=i&&s<=i},t.pad=function(t,e,i){i=i||"0";var n=t+"";return n.length>=e?n:new Array(e-n.length+1).join(i)+n},t}();t.NumberUtil=i;var n=function(){function t(){}return t.rgba=function(t,e,i,n){return"rgba("+t+","+e+","+i+","+n+")"},t.prototype.HSVtoRGB=function(t,e,i){var n,s,r,o,a,p,h,l;switch(1===arguments.length&&(e=t.s,i=t.v,t=t.h),p=i*(1-e),h=i*(1-(a=6*t-(o=Math.floor(6*t)))*e),l=i*(1-(1-a)*e),o%6){case 0:n=i,s=l,r=p;break;case 1:n=h,s=i,r=p;break;case 2:n=p,s=i,r=l;break;case 3:n=p,s=h,r=i;break;case 4:n=l,s=p,r=i;break;case 5:n=i,s=p,r=h}return{r:Math.round(255*n),g:Math.round(255*s),b:Math.round(255*r)}},t}();t.ColourUtil=n;var s=function(){function t(t,e){this.socket=t,this.pid=e}return t.prototype.fireWorldUpdated=function(t){this.socket.emit("world-update",t)},t}();t.Connection=s}(Util||(Util={})),function(t){var e=function(){function t(t){this.spacing=10,this.size=t.size}return t.prototype.draw=function(t){t.background(51)},t}();t.Arena=e}(Model||(Model={})),function(t){var e=Util.Vector,i=Util.NumberUtil,n=function(){function n(i){var n=this;this.idRingPulseCount=0,this.idRingPulseMax=2,this.idRingDuration=1500,this.setPos(new e(i.pos.x,i.pos.y)),this.dir=new e(i.dir.x,i.dir.y),this.spd=i.spd,this.colour=i.colour,this.trail=[],_.each(i.trail,function(e){n.trail.push(t.TrailSegment.fromDto(e))}),this.trailOpacity=1,this.idRingBlinkTime=-1,this.idRingBlinkOn=!1,this.idRingSize=0,this.respawning=!0}return n.prototype.update=function(t){if(t){var i=this.dir.x*this.spd,n=this.dir.y*this.spd;this.setPos(new e(this.pos.x+i,this.pos.y+n))}this.crashing&&(this.trailOpacity=Math.max(this.trailOpacity-.02,0),0==this.trailOpacity&&(this.crashing=!1,this.trailOpacity=1))},n.prototype.updateFromDto=function(e){var i=this;this.pos=e.pos,this.dir=e.dir,this.spd=e.spd,this.colour=e.colour,this.trail=[],_.each(e.trail,function(e){i.trail.push(t.TrailSegment.fromDto(e))}),this.respawning&&Date.now()-this.idRingDuration>this.lastRespawn&&(this.respawning=!1)},n.prototype.addTrailSegment=function(){var i=_.last(this.trail).end,n=new t.TrailSegment(new e(i.x,i.y),new e(this.pos.x,this.pos.y));this.trail.push(n)},n.prototype.crash=function(t){this.dir=new e(0,0),this.crashing=!0,this.addTrailSegment()},n.prototype.respawned=function(t){this.respawning=!0,this.crashing=!1,this.trailOpacity=1,this.lastRespawn=Date.now()},n.prototype.draw=function(n,s,r){if(this.respawning&&s){var o=Math.max(0,this.idRingSize-10);n.fill("rgba(0,0,0,0)"),n.stroke(255),n.strokeWeight(2),n.ellipse(this.pos.x,this.pos.y,this.idRingSize,this.idRingSize),n.stroke(this.colour.replace("%A%","1")),n.strokeWeight(1),n.ellipse(this.pos.x,this.pos.y,o,o),this.idRingSize=this.idRingSize+1.5,this.idRingSize>50&&(this.idRingSize=0,this.idRingPulseCount++,this.idRingPulseCount>=this.idRingPulseMax&&(this.respawning=!1,this.idRingPulseCount=0))}n.strokeWeight(2),n.stroke(this.colour.replace("%A%",this.trailOpacity.toString()));var a=_.find(this.trail,function(t){return t.isHead}).end,p=new t.TrailSegment(new e(a.x,a.y),new e(this.pos.x,this.pos.y)),h=_.clone(this.trail);h.push(p),n.noFill(),_.each(h,function(t){n.line(t.start.x,t.start.y,t.end.x,t.end.y)});var l=r?"rgb(255, 255, 255)":this.colour.replace("%A%","1");if(n.noStroke(),n.fill(l),n.ellipse(this.pos.x,this.pos.y,5,5),this.crashing){var c=i.rand255();n.stroke("rgba("+c+", 0, 0, 0.80)"),n.fill("rgba("+c+", "+c+" , 0, 0.75)"),n.ellipse(this.pos.x,this.pos.y,20,20);var u=Math.floor(35*Math.random());c=i.rand255(),n.stroke("rgba("+c+", "+c+" , 0, 0.55)"),n.fill("rgba("+i.rand255()+", 0, 0, 0.65)"),n.ellipse(this.pos.x,this.pos.y,u,u)}},n.prototype.getPos=function(){return this.pos},n.prototype.setPos=function(t){this.pos=t},n.prototype.getDir=function(){return this.dir},n.prototype.getSpd=function(){return this.spd},n.prototype.setSpd=function(t){this.spd=t},n.prototype.getColour=function(){return this.colour},n.prototype.isCrashing=function(){return this.crashing},n.prototype.isRespawning=function(){return this.respawning},n}();t.Bike=n}(Model||(Model={})),function(t){var e=function(){function t(t,e,i,n,s,r,o,a,p,h){this.pid=t,this.name=e,this.bike=i,this.crashed=n,this.spectating=s,this.deathTimestamp=r,this.crashedInto=o,this.crashedIntoName=a,this.score=p,this.isControlledPlayer=h,this.isAlive&&this.bike.respawned()}return t.prototype.getPid=function(){return this.pid},t.prototype.getName=function(){return this.name},t.prototype.setName=function(t){this.name=t},t.prototype.getBike=function(){return this.bike},t.prototype.setBike=function(t){this.bike=t},t.prototype.isCrashed=function(){return this.crashed},t.prototype.getCrashedInto=function(){return this.crashedInto},t.prototype.getCrashedIntoName=function(){return this.crashedIntoName},t.prototype.isAlive=function(){return!this.spectating&&!this.crashed},t.prototype.isVisible=function(){return!this.spectating||this.bike.isCrashing()},t.prototype.isSpectating=function(){return this.spectating},t.prototype.getCurrentPowerUp=function(){return this.currentPowerUp},t.prototype.getEffect=function(){return this.effect||"none"},t.prototype.update=function(){this.bike.update(this.isAlive())},t.prototype.draw=function(t,e){if(this.isVisible()){var i=this.isAlive()&&this.isControlledPlayer;this.bike.draw(t,i,this.isControlledPlayer),e&&(t.textSize(15),t.textAlign("center","middle"),t.text(this.name,this.bike.getPos().x,Math.max(0,this.bike.getPos().y-15)))}},t.prototype.updateFromDto=function(t){this.isAlive();!this.crashed&&t.crashed&&(this.bike.crash(),this.deathTimestamp=t.deathTimestamp||Math.floor(Date.now())),!t.crashed&&(this.crashed||this.spectating&&!t.spectating)&&this.bike.respawned();this.currentPowerUp;this.crashed=t.crashed,this.crashedInto=t.crashedInto,this.crashedIntoName=t.crashedIntoName,this.spectating=t.spectating,this.score=t.score,this.currentPowerUp=t.currentPowerUp?t.currentPowerUp.toLowerCase():null,this.effect=t.effect,this.bike.updateFromDto(t.bike)},t}();t.Player=e}(Model||(Model={})),function(t){var e=function(){function t(t,e,i){this.id=t,this.pos=e,this.type=i,this.collected=!1,this.collecting=!1,this.popSize=0}return t.prototype.getId=function(){return this.id},t.prototype.getPos=function(){return this.pos},t.prototype.setPos=function(t){this.pos=t},t.prototype.getType=function(){return this.type},t.prototype.setType=function(t){this.type=t},t.prototype.isCollected=function(){return this.collected},t.prototype.collect=function(){this.collected=!0,this.collecting=!0},t.prototype.updateFromDto=function(t){this.pos=t.pos,!this.collected&&t.collected&&this.collect()},t.prototype.draw=function(t){if(this.collected)this.collecting&&(t.fill("rgba(0,0,0,0)"),t.stroke(255),t.strokeWeight(2),t.ellipse(this.pos.x,this.pos.y,this.popSize,this.popSize),this.popSize=this.popSize+1.5,this.popSize>20&&(this.collecting=!1));else{t.push(),t.noStroke(),t.translate(this.pos.x,this.pos.y);switch(this.type.toLowerCase()){case"rocket":t.rotate(t.frameCount/-10),t.fill("rgb(255,255,105)"),t.triangle(-3,3*.8,3,3*.8,0,-3);break;case"slow":t.rotate(t.frameCount/50),t.fill("rgb(105,255,255)"),t.triangle(-3,3,3,3,0,-3),t.rotate(t.PI),t.triangle(-3,3,3,3,0,-3)}t.pop()}},t}();t.PowerUp=e}(Model||(Model={})),function(t){var e=function(){function t(t,e){this.start=t,this.end=e}return t.fromDto=function(e){var i=new t(e.start,e.end);return i.isHead=e.isHead,i},t.prototype.draw=function(t){},t}();t.TrailSegment=e}(Model||(Model={})),function(t){var e=Model.Bike,i=Model.Player,n=Model.PowerUp,s=Model.Arena,r=Util.Vector,o=Util.NumberUtil,a=function(){function t(){var t,e=this;this.host="http://"+window.location.hostname+":9092",this.socket=io.connect(this.host),this.players=[],this.powerUps=[],this.registered=!1,this.version="0.1b",this.gameStarted=!1,this.gameJoined=!1,this.showDebug=!1,this.showRespawn=!0,this.serverTimedOut=!1,this.socket.on("hello",function(t){e.initGame(t)}),this.socket.on("joined-game",function(t){e.joinGame(t)}),setInterval(function(){e.timeKeepAliveSent=(new Date).getTime(),e.socket.emit("keep-alive")},1e3),this.socket.on("keep-alive-ack",function(t){var i=(new Date).getTime();e.latency=i-e.timeKeepAliveSent,e.refreshServerTimeout()}),this.socket.on("world-update",function(t){e.gameStarted&&e.processWorldUpdate(t)}),this.socket.on("score-update",function(t){e.updateScores(t)}),this.socket.on("chat-message",function(t){var i="<li>";(i+="["+new Date(t.timestamp).toTimeString().split(" ")[0]+"]",t.isSystemMessage)?i+="&nbsp;<span style='color:#AFEEEE'>"+_.escape(t.message)+"</span>":(i+="&nbsp;<span style='color:"+t.sourceColour.replace("%A%","100")+"'><strong>"+t.source+"</strong></span>:",i+="&nbsp;"+_.escape(t.message));i+="</li>",$("#chat-log ul").append(i),$("#chat-log").scrollTop($("#chat-log")[0].scrollHeight),$("#message-list li").length>250&&$("#message-list li").first().remove(),e.messageCount=$("#message-list li").length}),function(t){t[t.LEFT_ARROW=37]="LEFT_ARROW",t[t.UP_ARROW=38]="UP_ARROW",t[t.RIGHT_ARROW=39]="RIGHT_ARROW",t[t.DOWN_ARROW=40]="DOWN_ARROW",t[t.W=87]="W",t[t.A=65]="A",t[t.S=83]="S",t[t.D=68]="D",t[t.R=82]="R",t[t.SPACE=32]="SPACE",t[t.F3=114]="F3",t[t.H=72]="H",t[t.TAB=9]="TAB",t[t.ENTER=13]="ENTER"}(t||(t={})),$(document).on("keyup",function(i){var n=i.which;e.player&&n===t.TAB&&(e.tabPressed=!1)}),$(document).on("keydown",function(i){if($(i.target).is("input")){if(i.which===t.ENTER){if($(i.target).is("#player-name-input")){var n=$("#player-name-input").val();e.nameIsValid(n)&&e.requestJoinGame(n)}else if($(i.target).is("#chat-input")){var s=$("#chat-input").val();""!=s.trim()&&(e.socket.emit("chat-message",s),$("#chat-input").val(""))}$(i.target).blur()}}else if(e.player){var o=i.which,a=null,p=!0;if(o===t.UP_ARROW||o===t.W?a=new r(0,-1):o===t.DOWN_ARROW||o===t.S?a=new r(0,1):o===t.RIGHT_ARROW||o===t.D?a=new r(1,0):o===t.LEFT_ARROW||o===t.A?a=new r(-1,0):o===t.F3?e.showDebug=!e.showDebug:o===t.R?e.socket.emit("request-respawn"):o===t.H?e.showRespawn=!e.showRespawn:o===t.TAB?e.tabPressed=!0:o===t.SPACE?e.socket.emit("use-powerup"):o===t.ENTER?$("#chat-input").focus():p=!1,p&&(i.preventDefault(),i.stopPropagation()),a){var h={pid:e.player.getPid(),xDir:a.x,yDir:a.y,xPos:e.player.getBike().getPos().x,yPos:e.player.getBike().getPos().y};e.socket.emit("update",h)}}}),$(document).ready(function(){$("#player-name-input").on("input",function(){var t=$("#player-name-input").val();e.nameIsValid(t)?$("#player-name-submit").show():$("#player-name-submit").hide()}),$("#player-name-submit").on("click",function(){var t=$("#player-name-input").val();e.requestJoinGame(t)})}),this.socket.emit("hello")}return t.prototype.setup=function(t){this.mainFont=t.loadFont("fonts/3Dventure.ttf"),this.secondaryFont=t.loadFont("fonts/visitor.ttf"),this.debugFont=t.loadFont("fonts/larabie.ttf"),this.powerUpIconRocket=t.loadImage("img/game/powerups/rocket.png"),this.powerUpIconSlow=t.loadImage("img/game/powerups/slow.png"),t.createCanvas(this.arena.size,this.arena.size)},t.prototype.nameIsValid=function(t){return t.trim().length>1&&t.trim().length<=15},t.prototype.refreshServerTimeout=function(){var t=this;this.serverTimeoutTimer&&(clearInterval(this.serverTimeoutTimer),this.serverTimeoutTimer=null),this.serverTimedOut=!1,this.serverTimeoutTimer=setInterval(function(){return t.serverTimedOut=!0},5e3)},t.prototype.requestJoinGame=function(t){var e={name:t};this.socket.emit("request-join-game",e)},t.prototype.joinGame=function(t){$("#welcome-container").hide(),$("#info-container").slideDown(),this.gameJoined=!0,this.player=new i(t.player.pid,t.player.name,new e(t.player.bike),t.player.crashed,t.player.spectating,t.player.deathTimestamp,t.player.crashedInto,t.player.crashedIntoName,t.player.score,!0),this.updateScores(t.scores)},t.prototype.initGame=function(t){var e=this;t.gameSettings.gameTickMs||console.error("Cannot start game - game tick interval is not defined"),this.gameTick=t.world.gameTick,this.arena=new s(t.world.arena),this.gameTickMs=t.gameSettings.gameTickMs,this.processWorldUpdate(t.world),this.p5Instance=new p5(this.sketch(),"game-container"),this.gameStarted=!0,$("#game").width(this.arena.size),$("#game").height(this.arena.size),setInterval(function(){e.gameTick++;e.gameJoined&&e.player.update(),_.each(e.players,function(t){t.update()})},this.gameTickMs)},t.prototype.calculateSpeedModifier=function(t){var e=this.arena.size,i=new r(e/2,e/2),n=new r(t.getPos().x,t.getPos().y);return.5*(r.distance(n,i)-0)/(e/2-0)+0},t.prototype.processWorldUpdate=function(t){var s=this;if(this.roundInProgress=t.roundInProgress,this.timeUntilNextRound=t.timeUntilNextRound,this.currentWinner=t.currentWinner,this.roundTimeLeft!=t.roundTimeLeft){var r=new Date(1e3*t.roundTimeLeft),a=o.pad(r.getMinutes(),2),p=o.pad(r.getSeconds(),2);$("#round-timer").text(a+":"+p)}this.roundTimeLeft=t.roundTimeLeft;var h=_.pluck(t.players,"pid"),l=_.pluck(this.players,"pid");_.each(l,function(t){_.contains(h,t)||(s.players=_.reject(s.players,function(e){return e.getPid()===t}))}),_.each(t.players,function(t){if(s.gameJoined&&t.pid===s.player.getPid()&&s.player)s.player.updateFromDto(t);else{var n=_.find(s.players,function(e){return e.getPid()===t.pid});if(n)n.updateFromDto(t);else{var r=new i(t.pid,t.name,new e(t.bike),t.crashed,t.spectating,t.deathTimestamp,t.crashedInto,t.crashedIntoName,t.score,!1);s.players.push(r)}}});var c=[];_.each(t.powerUps,function(t){new n(t.id,t.pos,t.type);var e=_.find(s.powerUps,function(e){return e.getId()===t.id});if(e)e.updateFromDto(t);else{var i=new n(t.id,t.pos,t.type);s.powerUps.push(i),e=i}c.push(e)}),this.powerUps=c,this.impacts=t.debug.impacts.map(function(t){return t.pos})},t.prototype.updateScores=function(t){var e=this;t=_.sortBy(t,function(t){return t.score}).reverse();var i=_.first(t,5);$("#score ul").empty();var n=!1;if(i.forEach(function(t,i){var s=e.gameJoined&&t.pid==e.player.getPid(),r=_.first(e.players.filter(function(e){return e.getPid()==t.pid}));n=s||n;var o=(s?"<li style='color:yellow'>":"<li>")+("#"+(i+1))+" <span style='color:"+(!r||s?"inherit":r.getBike().getColour().replace("%A%","1"))+"'>"+t.name+"</span>: "+t.score+"</li>";$("#score ul").append(o)}),this.gameJoined&&!n){var s=t.filter(function(t){return t.pid==e.player.getPid()})[0];if(!s)return;var r="<li style='color:yellow'>"+("#"+(t.indexOf(s)+1))+" "+s.name+": "+s.score+"</li>";$("#score ul").append(r)}},t.prototype.getPowerUpIcon=function(t){switch(t){case"rocket":return this.powerUpIconRocket;case"slow":return this.powerUpIconSlow;default:return null}},t.prototype.sketch=function(){var t=this;return function(e){e.setup=function(){return t.setup(e)},e.draw=function(){return t.draw(e)}}},t.prototype.draw=function(t){var e=this,i=this.arena.size/2,n=this.arena.size/2;if(this.arena.draw(t),this.roundInProgress&&(_.each(this.powerUps,function(e){e.draw(t)}),_.each(this.players,function(i){i.draw(t,e.tabPressed)})),this.serverTimedOut)return t.noStroke(),t.fill("rgba(0,0,0,0.4)"),t.rect(0,n-35,this.arena.size,55),t.textFont(this.mainFont),t.textAlign("center","top"),t.fill("rgba(125,249,255,0.50)"),t.textSize(29),t.text("He's dead, Jim",i+o.randInt(0,2),n-30+o.randInt(0,2)),t.fill("rgba(255,255,255,0.80)"),t.textSize(28),t.text("He's dead, Jim",i,n-30),t.fill("rgba(0,0,0,0.40)"),t.fill(255),t.textFont(this.secondaryFont),t.textSize(15),void t.text("Lost connection to the server",i,n);if(this.gameJoined){if(this.roundInProgress){this.player.draw(t,this.tabPressed);var s=this.getPowerUpIcon(this.player.getCurrentPowerUp());if(s){var r=this.player.getBike().getPos();r.x<75&&r.y<75?t.tint(255,100):t.tint(255,200),t.image(s,5,5,30,30)}}if(this.player.isCrashed()&&this.player.isSpectating()&&this.showRespawn&&this.roundInProgress){if(t.noStroke(),t.fill("rgba(0,0,0,0.4)"),t.rect(0,n-35,this.arena.size,100),t.textFont(this.mainFont),t.textAlign("center","top"),this.player.isCrashed()){var a="";a=this.player.getCrashedInto()==this.player.getPid()?"You killed yourself, idiot":"Killed by "+this.player.getCrashedIntoName(),t.fill("rgba(125,249,255,0.50)"),t.textSize(29),t.text(a,i+o.randInt(0,2),n-30+o.randInt(0,2)),t.fill("rgba(255,255,255,0.80)"),t.textSize(28),t.text(a,i,n-30)}t.fill("rgba(125,249,255,0.50)"),t.textSize(33),t.text("Press 'R' to respawn",i+o.randInt(0,2),n+o.randInt(0,2)),t.fill("rgba(255,255,255,0.80)"),t.textSize(32),t.text("Press 'R' to respawn",i,n),t.fill("rgba(0,0,0,0.40)"),t.fill(255),t.textFont(this.secondaryFont),t.textSize(15),t.text("Press 'H' to hide",i,n+45)}}if(!this.roundInProgress){var p=this.gameJoined&&this.currentWinner===this.player.getPid()?this.player:_.find(this.players,function(t){return t.getPid()===e.currentWinner}),h="The Wall";p&&(h=p.getName()),t.noStroke(),t.fill("rgba(0,0,0,0.4)"),t.rect(0,n-35,this.arena.size,55),t.textFont(this.mainFont),t.textAlign("center","top"),t.fill("rgba(125,249,255,0.50)"),t.textSize(29),t.text(h+" won!",i+o.randInt(0,2),n-30+o.randInt(0,2)),t.fill("rgba(255,255,255,0.80)"),t.textSize(28),t.text(h+" won!",i,n-30),t.fill("rgba(0,0,0,0.40)"),t.fill(255),t.textFont(this.secondaryFont),t.textSize(15),t.text("Next round starting in "+this.timeUntilNextRound+" second"+(1===this.timeUntilNextRound?"":"s"),i,n)}if(this.player&&this.player.isAlive()&&"slowed"==this.player.getEffect().toLowerCase()&&t.filter("INVERT",0),_.each(this.impacts,function(e){t.noStroke(),t.fill("rgba(255, 165, 0, 0.6)"),t.ellipse(e.x,e.y,20,20)}),this.showDebug)if(t.textFont(this.debugFont),t.fill(255),t.textSize(15),t.textAlign("left","top"),t.text("LitBikes "+this.version,10,10),this.gameJoined){var l=this.player.getBike();t.text("fps: "+t.frameRate().toFixed(2)+"\nms: "+this.latency+"ms\npid: "+this.player.getPid()+"\npos: "+l.getPos().x.toFixed(0)+", "+l.getPos().y.toFixed(0)+"\ndir: "+l.getDir().x+", "+l.getDir().y+"\nspd: "+l.getSpd()+"\ncrashed: "+(this.player.isCrashed()?"yes":"no")+"\ncrashing: "+(l.isCrashing()?"yes":"no")+"\nNaN"+l.getColour()+"\nspectating: "+(this.player.isSpectating()?"yes":"no")+"\nround in progress: "+(this.roundInProgress?"yes":"no")+"\nround time left: "+this.roundTimeLeft+"\ntime until next round: "+this.timeUntilNextRound+"\nother players: "+this.players.length+"\nchat message count: "+this.messageCount+"\n",10,30,300,500)}else t.text("Game not joined",10,30,300,500)},t}();t.Game=a,new a}(Game||(Game={}));